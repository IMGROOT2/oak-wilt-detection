<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Oak Wilt Clusters - Interactive Map</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #1a1a1a;
            color: #ffffff;
        }
        
        #header {
            background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
            padding: 20px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
        }
        
        h1 {
            text-align: center;
            font-size: 2em;
            margin-bottom: 10px;
            color: #ecf0f1;
        }
        
        .subtitle {
            text-align: center;
            color: #bdc3c7;
            margin-top: 5px;
        }
        
        #controls {
            max-width: 1200px;
            margin: 20px auto;
            padding: 0 20px;
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            align-items: center;
        }
        
        .control-group {
            display: flex;
            align-items: center;
            gap: 10px;
            background-color: #2c2c2c;
            padding: 10px 15px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
        }
        
        label {
            font-weight: 600;
            color: #ecf0f1;
            white-space: nowrap;
        }
        
        select {
            padding: 8px 12px;
            border: 2px solid #3498db;
            border-radius: 6px;
            background-color: #34495e;
            color: #ffffff;
            font-size: 14px;
            cursor: pointer;
            min-width: 200px;
            transition: all 0.3s ease;
        }
        
        select:hover {
            border-color: #5dade2;
            background-color: #3d566e;
        }
        
        select:focus {
            outline: none;
            border-color: #5dade2;
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.2);
        }
        
        button {
            padding: 8px 16px;
            background: linear-gradient(135deg, #3498db 0%, #2980b9 100%);
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s ease;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }
        
        button:hover {
            background: linear-gradient(135deg, #5dade2 0%, #3498db 100%);
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
        }
        
        button:active {
            transform: translateY(0);
        }
        
        #map {
            width: 100%;
            height: calc(100vh - 200px);
            border-top: 3px solid #3498db;
        }
        
        #info-panel {
            max-width: 1200px;
            margin: 0 auto 20px;
            padding: 15px 20px;
            background-color: #2c2c2c;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
            display: none;
        }
        
        #info-panel.active {
            display: block;
        }
        
        .info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            margin-top: 10px;
        }
        
        .info-item {
            background-color: #34495e;
            padding: 12px;
            border-radius: 6px;
            border-left: 4px solid #3498db;
        }
        
        .info-label {
            font-weight: 600;
            color: #3498db;
            font-size: 0.9em;
            margin-bottom: 5px;
        }
        
        .info-value {
            font-size: 1.1em;
            color: #ecf0f1;
        }
        
        .legend {
            background: rgba(44, 44, 44, 0.95);
            padding: 15px;
            border-radius: 8px;
            border: 2px solid #3498db;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.4);
        }
        
        .legend h4 {
            margin-bottom: 10px;
            color: #3498db;
            font-size: 1.1em;
        }
        
        .legend-item {
            display: flex;
            align-items: center;
            margin: 8px 0;
            gap: 10px;
        }
        
        .legend-color {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            border: 2px solid #fff;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
        }
        
        .leaflet-popup-content-wrapper {
            background-color: #2c3e50;
            color: #ecf0f1;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.5);
        }
        
        .leaflet-popup-content {
            margin: 15px;
        }
        
        .leaflet-popup-tip {
            background-color: #2c3e50;
        }
        
        .popup-title {
            font-weight: 700;
            font-size: 1.1em;
            color: #3498db;
            margin-bottom: 8px;
            border-bottom: 2px solid #3498db;
            padding-bottom: 5px;
        }
        
        .popup-info {
            line-height: 1.6;
        }
        
        .popup-label {
            font-weight: 600;
            color: #5dade2;
        }
        
        @media (max-width: 768px) {
            #controls {
                flex-direction: column;
                align-items: stretch;
            }
            
            .control-group {
                flex-direction: column;
                align-items: stretch;
            }
            
            select {
                width: 100%;
            }
            
            .info-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div id="header">
        <h1>ðŸŒ³ Oak Wilt Clusters - Interactive Map</h1>
        <div class="subtitle" id="subtitle">
            Loading data...
        </div>
    </div>
    
    <div id="controls">
        <div class="control-group">
            <label for="cluster-select">Select Cluster:</label>
            <select id="cluster-select">
                <option value="all">All Clusters</option>
            </select>
        </div>
        <div class="control-group">
            <button id="reset-view">Reset View</button>
            <button id="toggle-info">Show Info</button>
        </div>
    </div>
    
    <div id="info-panel">
        <h3 style="color: #3498db; margin-bottom: 10px;">Cluster Information</h3>
        <div class="info-grid">
            <div class="info-item">
                <div class="info-label">Cluster ID</div>
                <div class="info-value" id="info-id">-</div>
            </div>
            <div class="info-item">
                <div class="info-label">Total Cases</div>
                <div class="info-value" id="info-cases">-</div>
            </div>
            <div class="info-item">
                <div class="info-label">Time Span</div>
                <div class="info-value" id="info-timespan">-</div>
            </div>
            <div class="info-item">
                <div class="info-label">Geographic Center</div>
                <div class="info-value" id="info-center">-</div>
            </div>
        </div>
    </div>
    
    <div id="map"></div>
    
    <!-- Load cluster data first (with cache-busting parameter) -->
    <script src="../data/oak_wilt_clusters.js?v=2"></script>
    
    <script>
        // clusterData is now globally available from oak_wilt_clusters.js
        // No need to declare it again
        let map = null;
        let markersLayer = null;
        let clusterCentersLayer = null;
        
        // Color palette for clusters
        const clusterColors = [
            '#e74c3c', '#3498db', '#2ecc71', '#f39c12', '#9b59b6',
            '#1abc9c', '#e67e22', '#34495e', '#16a085', '#c0392b',
            '#27ae60', '#2980b9', '#8e44ad', '#f1c40f', '#d35400',
            '#c0392b', '#7f8c8d', '#2c3e50', '#95a5a6', '#e74c3c'
        ];
        
        // Initialize map
        function initMap() {
            // Create map centered on Austin, TX
            map = L.map('map').setView([30.2672, -97.7431], 11);
            
            // Add satellite tile layer (Esri World Imagery)
            L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
                attribution: 'Tiles &copy; Esri &mdash; Source: Esri, i-cubed, USDA, USGS, AEX, GeoEye, Getmapping, Aerogrid, IGN, IGP, UPR-EGP, and the GIS User Community',
                maxZoom: 18
            }).addTo(map);
            
            // Add labels overlay
            L.tileLayer('https://{s}.basemaps.cartocdn.com/light_only_labels/{z}/{x}/{y}{r}.png', {
                attribution: '&copy; OpenStreetMap contributors &copy; CARTO',
                subdomains: 'abcd',
                maxZoom: 18,
                pane: 'shadowPane'
            }).addTo(map);
            
            // Create layer groups
            markersLayer = L.layerGroup().addTo(map);
            clusterCentersLayer = L.layerGroup().addTo(map);
            
            // Add legend
            addLegend();
        }
        
        // Add legend to map
        function addLegend() {
            const legend = L.control({ position: 'bottomright' });
            
            legend.onAdd = function(map) {
                const div = L.DomUtil.create('div', 'legend');
                div.innerHTML = `
                    <h4>Legend</h4>
                    <div class="legend-item">
                        <div class="legend-color" style="background-color: #e74c3c;"></div>
                        <span>Individual Cases</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background-color: #f39c12; width: 30px; height: 30px;"></div>
                        <span>Cluster Center</span>
                    </div>
                `;
                return div;
            };
            
            legend.addTo(map);
        }
        
        // Get color for cluster
        function getClusterColor(clusterId) {
            return clusterColors[clusterId % clusterColors.length];
        }
        
        // Load cluster data from loaded script
        function loadClusterData() {
            // clusterData is now globally available from oak_wilt_clusters.js
            populateDropdownAndDisplay();
        }
        
        // Populate dropdown and display initial view
        function populateDropdownAndDisplay() {
            // Update subtitle with dynamic data
            const metadata = clusterData.metadata;
            let yearStart = Infinity;
            let yearEnd = -Infinity;
            
            // Find min and max years across all clusters
            clusterData.clusters.forEach(cluster => {
                if (cluster.statistics.temporal_range.year_start < yearStart) {
                    yearStart = cluster.statistics.temporal_range.year_start;
                }
                if (cluster.statistics.temporal_range.year_end > yearEnd) {
                    yearEnd = cluster.statistics.temporal_range.year_end;
                }
            });
            
            // Update subtitle
            const subtitle = document.getElementById('subtitle');
            subtitle.textContent = `Austin, Texas | ${yearStart}-${yearEnd} | ${metadata.num_clusters} Clusters Identified | ${metadata.total_cases.toLocaleString()} Total Cases`;
            
            // Populate dropdown
            const select = document.getElementById('cluster-select');
            clusterData.clusters.forEach(cluster => {
                const option = document.createElement('option');
                option.value = cluster.cluster_id;
                option.textContent = `Cluster ${cluster.cluster_id} (${cluster.statistics.total_cases} cases, ${cluster.statistics.temporal_range.year_start}-${cluster.statistics.temporal_range.year_end})`;
                select.appendChild(option);
            });
            
            // Display all clusters initially
            displayClusters('all');
        }
        
        // Display clusters on map
        function displayClusters(clusterId) {
            // Clear existing markers
            markersLayer.clearLayers();
            clusterCentersLayer.clearLayers();
            
            if (!clusterData) return;
            
            let clustersToDisplay = [];
            
            if (clusterId === 'all') {
                clustersToDisplay = clusterData.clusters;
                document.getElementById('info-panel').classList.remove('active');
            } else {
                clustersToDisplay = clusterData.clusters.filter(c => c.cluster_id == clusterId);
                if (clustersToDisplay.length > 0) {
                    updateInfoPanel(clustersToDisplay[0]);
                }
            }
            
            // Calculate bounds for fitting map view
            let bounds = [];
            
            // Add markers for each cluster
            clustersToDisplay.forEach(cluster => {
                const color = getClusterColor(cluster.cluster_id);
                const stats = cluster.statistics;
                
                // Add cluster center marker
                const centerMarker = L.circleMarker(
                    [stats.geographic_center.latitude, stats.geographic_center.longitude],
                    {
                        radius: 12,
                        fillColor: '#f39c12',
                        color: '#fff',
                        weight: 3,
                        opacity: 1,
                        fillOpacity: 0.8
                    }
                );
                
                centerMarker.bindPopup(`
                    <div class="popup-title">Cluster ${cluster.cluster_id} Center</div>
                    <div class="popup-info">
                        <div><span class="popup-label">Total Cases:</span> ${stats.total_cases}</div>
                        <div><span class="popup-label">Time Period:</span> ${stats.temporal_range.year_start}-${stats.temporal_range.year_end}</div>
                        <div><span class="popup-label">Duration:</span> ${stats.temporal_range.year_span} years</div>
                        <div><span class="popup-label">Center:</span> ${stats.geographic_center.latitude.toFixed(6)}, ${stats.geographic_center.longitude.toFixed(6)}</div>
                    </div>
                `);
                
                clusterCentersLayer.addLayer(centerMarker);
                bounds.push([stats.geographic_center.latitude, stats.geographic_center.longitude]);
                
                // Add individual case markers
                cluster.cases.forEach(case_data => {
                    const marker = L.circleMarker(
                        [case_data.latitude, case_data.longitude],
                        {
                            radius: 4,
                            fillColor: color,
                            color: '#fff',
                            weight: 1,
                            opacity: 0.8,
                            fillOpacity: 0.6
                        }
                    );
                    
                    marker.bindPopup(`
                        <div class="popup-title">Oak Wilt Case</div>
                        <div class="popup-info">
                            <div><span class="popup-label">Cluster ID:</span> ${cluster.cluster_id}</div>
                            <div><span class="popup-label">Date:</span> ${case_data.inspection_date}</div>
                            <div><span class="popup-label">Year:</span> ${case_data.inspection_year}</div>
                            <div><span class="popup-label">Species:</span> ${case_data.species}</div>
                            <div><span class="popup-label">Landowner:</span> ${case_data.landowner_type}</div>
                            <div><span class="popup-label">Location:</span> ${case_data.latitude.toFixed(6)}, ${case_data.longitude.toFixed(6)}</div>
                        </div>
                    `);
                    
                    markersLayer.addLayer(marker);
                    bounds.push([case_data.latitude, case_data.longitude]);
                });
            });
            
            // Fit map to bounds if we have markers
            if (bounds.length > 0) {
                map.fitBounds(bounds, { padding: [50, 50] });
            }
        }
        
        // Update info panel with cluster information
        function updateInfoPanel(cluster) {
            const stats = cluster.statistics;
            document.getElementById('info-id').textContent = cluster.cluster_id;
            document.getElementById('info-cases').textContent = stats.total_cases;
            document.getElementById('info-timespan').textContent = `${stats.temporal_range.year_start}-${stats.temporal_range.year_end} (${stats.temporal_range.year_span} years)`;
            document.getElementById('info-center').textContent = `${stats.geographic_center.latitude.toFixed(4)}Â°N, ${Math.abs(stats.geographic_center.longitude).toFixed(4)}Â°W`;
            document.getElementById('info-panel').classList.add('active');
        }
        
        // Event listeners
        document.getElementById('cluster-select').addEventListener('change', function(e) {
            displayClusters(e.target.value);
        });
        
        document.getElementById('reset-view').addEventListener('click', function() {
            map.setView([30.2672, -97.7431], 11);
        });
        
        document.getElementById('toggle-info').addEventListener('click', function() {
            const panel = document.getElementById('info-panel');
            const button = document.getElementById('toggle-info');
            if (panel.classList.contains('active')) {
                panel.classList.remove('active');
                button.textContent = 'Show Info';
            } else {
                const select = document.getElementById('cluster-select');
                if (select.value !== 'all') {
                    panel.classList.add('active');
                    button.textContent = 'Hide Info';
                } else {
                    alert('Please select a specific cluster to view information.');
                }
            }
        });
        
        /*
         * NOTE: To view this HTML file locally without a server, you may need to:
         * - Chrome: Launch with flag --allow-file-access-from-files
         * - Firefox: Should work by default with local files
         * - Safari: Develop > Disable Local File Restrictions
         * 
         * Or simply open this file by double-clicking it in most browsers.
         */
        
        // Initialize on page load
        window.addEventListener('load', function() {
            initMap();
            loadClusterData();
        });
    </script>
</body>
</html>
